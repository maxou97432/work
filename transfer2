import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

base_ml["BIEN_NEUF"] = np.where(
    (base_ml["NATURE_MUTATION"] == "Vente en l'état futur d'achèvement") |
    (base_ml["CD_NATUR_OP"] == "AQN"),
    "Neuf",
    "Ancien"
)


counts = base_ml['BIEN_NEUF'].value_counts()
percentages = (counts / len(base_ml)) * 100

result_df = pd.DataFrame({
    'Nombre': counts,
    'Pourcentage (%)': percentages.round(2)
})
print("Répartition de l'ancienneté des biens sur l'ensemble de la base")
print("--" * 22)
print(result_df)


df_grouped = base_ml.groupby(['YEAR', 'BIEN_NEUF'])['ID'].count().reset_index(name='Nombre_transactions')


total_per_year = df_grouped.groupby('YEAR')['Nombre_transactions'].sum()


pivot_df = df_grouped.pivot(index='YEAR', columns='BIEN_NEUF', values='Nombre_transactions')


pourcentage_df = pivot_df.div(total_per_year, axis=0) * 100


pourcentage_df.plot(kind='bar', stacked=False)
plt.title("Évolution annuelle du pourcentage de transactions par anceinneté de bien")
plt.xlabel("Année")
plt.ylabel("Pourcentage de transactions")
plt.legend(title="Type de bien")
plt.tight_layout()
plt.show()
