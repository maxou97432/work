
univers_complet_ville = univers_complet_ville[univers_complet_ville["Ville"].isin(top15)]

univers_complet_ville = univers_complet_ville.rename(columns={"ville_":"Ville"})
univers_complet_ville["Ville"] = univers_complet_ville["Ville"].astype(str).str.strip().str.upper()
univers_complet_ville["TYPE_BIEN"] = univers_complet_ville["TYPE_BIEN"].astype(str).str.strip().str.upper()
univers_complet_ville["NB_PIECES_RANGE"] = univers_complet_ville["NB_PIECES_RANGE"].astype(str).str.strip().str.upper()


mask_valid = (univers_complet_ville["nb_transac"] > 0) & (
    univers_complet_ville["prix_median"].notna() | univers_complet_ville["prix_moyen"].notna()
)
u = univers_complet_ville.loc[mask_valid].copy()

u["poids"] = u["nb_transac"] / u.groupby("Ville")["nb_transac"].transform("sum")

def _wsum(series, weights):
    return (series.fillna(0) * weights).sum()

agg = (
    u.groupby("Ville", as_index=False)
     .apply(lambda g: pd.Series({
         "Prix pondéré médian": _wsum(g["prix_median"], g["poids"]),
         "Prix pondéré moyen": _wsum(g["prix_moyen"], g["poids"]),
         "Nombre transactions totales": g["nb_transac"].sum()
     }))
)

df_plot = agg.sort_values("Prix pondéré moyen", ascending=False)

fig = px.bar(
    df_plot,
    x="Ville",
    y="Prix pondéré moyen",
    hover_data={"Nombre transactions totales": True, "Prix pondéré médian": ":.0f"},
    text="Prix pondéré moyen"
)

fig.update_traces(texttemplate="%{text:.0f}", textposition="outside", cliponaxis=False)
fig.update_layout(
    title="Prix pondéré par ville (€ / m²) – pondération par répartition des transactions",
    yaxis_title="€ / m²",
    xaxis_title="Ville",
    uniformtext_minsize=8,
    uniformtext_mode="hide",
    bargap=0.25,
    height=520
)
fig.update_yaxes(tickformat=",") 

fig.show()
fig.write_html(r"N:\uflumth\indicateur_marche\prix_m2\my_cl_estim\resultats\prix_pondere_par_ville.html")
