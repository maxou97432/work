import plotly.express as px
import plotly.io as pio

pio.renderers.default = "notebook"   # ou "browser" si besoin

# --- Ton calcul (inchangé) ---
distribution = (
    base_ml.groupby(['TYPE_BIEN', 'NB_PIECES_RANGE'])['ID']
           .count()
           .reset_index(name='Nombre')
)
tot = distribution.groupby("TYPE_BIEN")["Nombre"].transform("sum")
distribution['Pourcentage'] = (distribution['Nombre'] / tot) * 100

# (Optionnel) ordre des catégories pour affichage plus propre
categorie_order = [
    "APT: 1-2 pièces", "APT : 3-4 pièces", "APT: 5 pièces et plus", "APT: Non renseigné",
    "MAI: 4 pièces et moins", "MAI: 5 pièces et plus", "MAI: Non renseigné"
]
distribution['NB_PIECES_RANGE'] = pd.Categorical(distribution['NB_PIECES_RANGE'],
                                                 categories=categorie_order, ordered=True)

# 1) Barres groupées: même axe X, couleur = type de bien
fig_group = px.bar(
    distribution.sort_values(['NB_PIECES_RANGE','TYPE_BIEN']),
    x='NB_PIECES_RANGE', y='Pourcentage',
    color='TYPE_BIEN',
    barmode='group',
    text=distribution['Pourcentage'].round(1).astype(str) + '%',
    title="Distribution du nombre de pièces par type de bien (en %)"
)
fig_group.update_traces(textposition='outside')
fig_group.update_layout(
    xaxis_title="Classe de pièces",
    yaxis_title="Pourcentage de transactions",
    title_x=0.5,
    xaxis_tickangle=45,
    plot_bgcolor="white",
    legend_title="Type de bien",
    uniformtext_minsize=8, uniformtext_mode='hide'
)
fig_group.show()

# 2) Facettes par type (plus lisible car classes différentes APT vs MAI)
fig_facet = px.bar(
    distribution,
    x='NB_PIECES_RANGE', y='Pourcentage',
    color='NB_PIECES_RANGE',
    text=distribution['Pourcentage'].round(1).astype(str) + '%',
    facet_col='TYPE_BIEN',
    facet_col_spacing=0.08,
    title="Distribution du nombre de pièces — Facetté par type de bien (en %)"
)
fig_facet.update_traces(textposition='outside', showlegend=False)
fig_facet.update_layout(
    xaxis_title=None, yaxis_title="Pourcentage de transactions",
    title_x=0.5, plot_bgcolor="white",
)
# Rotation des ticks x sur chaque facette
for ax in fig_facet.layout.annotations:
    ax.text = ax.text.replace("TYPE_BIEN=", "")
fig_facet.update_xaxes(tickangle=45)
fig_facet.show()
