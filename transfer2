import plotly.express as px
import plotly.io as pio
import pandas as pd

pio.renderers.default = "notebook"  # ou "browser"

# --- Calcul des parts globales ---
distribution_global = (
    base_ml.groupby(['TYPE_BIEN', 'NB_PIECES_RANGE'])['ID']
           .count()
           .reset_index(name='Nombre')
)

# Pourcentage par rapport au total global (tous types confondus)
total_global = distribution_global['Nombre'].sum()
distribution_global['Pourcentage_total'] = (
    distribution_global['Nombre'] / total_global * 100
)

# Optionnel : trier les catégories
categorie_order = [
    "APT: 1-2 pièces", "APT : 3-4 pièces", "APT: 5 pièces et plus", "APT: Non renseigné",
    "MAI: 4 pièces et moins", "MAI: 5 pièces et plus", "MAI: Non renseigné"
]
distribution_global['NB_PIECES_RANGE'] = pd.Categorical(
    distribution_global['NB_PIECES_RANGE'],
    categories=categorie_order,
    ordered=True
)

# --- Graphique Plotly ---
fig = px.bar(
    distribution_global.sort_values('Pourcentage_total', ascending=False),
    x='NB_PIECES_RANGE',
    y='Pourcentage_total',
    color='TYPE_BIEN',
    text=distribution_global['Pourcentage_total'].round(1).astype(str) + '%',
    title="Répartition des catégories de nombre de pièces (tous biens confondus)",
    color_discrete_map={'APT': '#1f77b4', 'MAI': '#ff7f0e'},
    barmode='group'  # tu peux changer en 'stack' pour voir la contribution cumulée
)

fig.update_traces(textposition='outside')
fig.update_layout(
    xaxis_title="Catégorie (nombre de pièces)",
    yaxis_title="Part dans le total (%)",
    title_x=0.5,
    xaxis_tickangle=45,
    plot_bgcolor="white",
    legend_title="Type de bien"
)

fig.show()
