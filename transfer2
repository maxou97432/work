from prophet import Prophet
import plotly.graph_objects as go
import plotly.io as pio

pio.renderers.default = "notebook"

cols = [
    "Prix moyen glissant 12 mois - Univ Elem",
    "Prix moyen glissant 12 mois - LPI/IAD",
    "Prix moyen glissant 12 mois - CL",
    "Prix moyen glissant 3 mois - Univ Elem"
]

for ville in fusion["Ville"].unique():
    df_ville = fusion[fusion["Ville"] == ville].copy()
    fig = go.Figure()

    for col in cols:
        if col not in df_ville.columns:
            continue

        # Pr√©paration des donn√©es
        df_col = df_ville[["DATE", col]].rename(columns={"DATE": "ds", col: "y"}).dropna(subset=["y"])
        if df_col.empty:
            continue

        # Entra√Ænement du mod√®le Prophet
        model = Prophet()
        model.fit(df_col)

        # Pr√©vision 12 mois dans le futur
        future = model.make_future_dataframe(periods=12, freq="M")
        forecast = model.predict(future)

        # --- On s√©pare pass√© / futur ---
        last_date = df_col["ds"].max()
        forecast_future = forecast[forecast["ds"] > last_date]

        # S√©rie r√©elle
        fig.add_trace(go.Scatter(
            x=df_col["ds"],
            y=df_col["y"],
            mode="lines+markers",
            name=f"{col} (r√©el)",
            line=dict(width=2)
        ))

        # Pr√©vision Prophet (future seulement)
        fig.add_trace(go.Scatter(
            x=forecast_future["ds"],
            y=forecast_future["yhat"],
            mode="lines",
            name=f"Pr√©vision Prophet - {col}",
            line=dict(dash="dot")
        ))

    # Mise en forme
    fig.update_layout(
        title=f"üìà Pr√©vision Prophet de toutes les m√©thodes - {ville}",
        xaxis_title="Date",
        yaxis_title="Prix au m¬≤",
        template="plotly_white",
        legend=dict(
            yanchor="bottom",
            y=0.01,
            xanchor="right",
            x=0.99,
            bgcolor="rgba(255,255,255,0.6)"
        ),
        height=550
    )

    fig.show()
