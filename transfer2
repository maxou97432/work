def calcule_prix_pondere_ville_periode(g):
    """
    Calcule les prix moyens pondérés avec fenêtres dynamiques 3m et 12m.
    Seules les typologies ayant à la fois un prix ET une activité récente sont incluses.
    """
    # Typologies avec prix ce mois-ci ET actives dans la fenêtre temporelle
    valid_3m  = (g["prix_moyen"].notna()) & (g["I_3m"] == 1)
    valid_12m = (g["prix_moyen"].notna()) & (g["I_12m"] == 1)
    
    # --- Calcul pour fenêtre 3 mois ---
    if valid_3m.sum() > 0:
        # Extraire les poids des typologies valides
        poids_3m = g.loc[valid_3m, "poids_relatif"]
        prix_3m = g.loc[valid_3m, "prix_moyen"]
        
        # Renormaliser les poids pour qu'ils somment à 1
        poids_3m_norm = poids_3m / poids_3m.sum()
        
        # Moyenne pondérée
        prix_pondere_3m = np.average(prix_3m, weights=poids_3m_norm)
    else:
        prix_pondere_3m = np.nan
    
    # --- Calcul pour fenêtre 12 mois ---
    if valid_12m.sum() > 0:
        # Extraire les poids des typologies valides
        poids_12m = g.loc[valid_12m, "poids_relatif"]
        prix_12m = g.loc[valid_12m, "prix_moyen"]
        
        # Renormaliser les poids pour qu'ils somment à 1
        poids_12m_norm = poids_12m / poids_12m.sum()
        
        # Moyenne pondérée
        prix_pondere_12m = np.average(prix_12m, weights=poids_12m_norm)
    else:
        prix_pondere_12m = np.nan
    
    return pd.Series({
        "prix_moyen_pondere_dyn_3m":  prix_pondere_3m,
        "prix_moyen_pondere_dyn_12m": prix_pondere_12m
    })
