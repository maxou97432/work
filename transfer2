import pandas as pd
import plotly.express as px
import plotly.io as pio

# Affichage dans le notebook (change en "browser" si besoin)
pio.renderers.default = "notebook"

# --- 1) Nombre de transactions par an ---
j = base_ml.groupby('YEAR')['ID'].count().reset_index(name='Nombre de transactions')

fig1 = px.bar(
    j.sort_values('YEAR'),
    x='YEAR', y='Nombre de transactions',
    text='Nombre de transactions',
    title="Évolution annuelle du nombre de transactions"
)
fig1.update_traces(textposition='outside')
fig1.update_layout(
    xaxis_title="Année",
    yaxis_title="Nombre de transactions",
    title_x=0.5,
    plot_bgcolor="white"
)
fig1.show()

# --- 2) % de transactions par source et par an ---
df_grouped = (
    base_ml.groupby(['YEAR', 'SOURCE'])['ID']
           .count()
           .reset_index(name='Nombre_transactions')
)

# Normalisation en pourcentage par année
df_grouped['Total_year'] = df_grouped.groupby('YEAR')['Nombre_transactions'].transform('sum')
df_grouped['Pourcentage'] = df_grouped['Nombre_transactions'] / df_grouped['Total_year'] * 100

fig2 = px.bar(
    df_grouped.sort_values('YEAR'),
    x='YEAR', y='Pourcentage', color='SOURCE',
    barmode='group', text='Pourcentage',
    title="Évolution annuelle du pourcentage du nombre de transactions par source"
)
fig2.update_traces(texttemplate="%{text:.1f}%", textposition='outside')
fig2.update_layout(
    xaxis_title="Année",
    yaxis_title="Pourcentage de transactions",
    title_x=0.5,
    plot_bgcolor="white",
    legend_title="Source"
)
fig2.show()

# ----- Variante empilée à 100% (si tu préfères) -----
# fig2_stack = px.bar(
#     df_grouped.sort_values('YEAR'),
#     x='YEAR', y='Nombre_transactions', color='SOURCE',
#     barmode='stack',
#     title="Répartition annuelle des transactions par source (100% empilé)"
# )
# fig2_stack.update_layout(
#     xaxis_title="Année", yaxis_title="Part (%)",
#     title_x=0.5, plot_bgcolor="white"
# )
# fig2_stack.update_yaxes(tickformat=".0%")
# fig2_stack.show()
