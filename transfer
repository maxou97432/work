def calcule_moyenne_mobile_ponderee(g, window, col_prix, col_indicatrice):
    """
    Calcule une moyenne mobile pondérée sur 3 et 12 mois.
    
    Pour chaque mois t :
    - Regarde les 3/12 derniers mois
    - Pour chaque sous-univers : prend les prix où indicatrice = 1
    - Fait une moyenne pondérée de tous ces prix

    """
    result = []
    
    g = g.sort_values("Periode")
    periodes = g["Periode"].unique()
    
    for i, periode in enumerate(periodes):
        # Fenêtre : 'window' derniers mois incluant le mois actuel
        start_idx = max(0, i - window + 1)
        periodes_fenetre = periodes[start_idx:i+1]
        
        # Données de la fenêtre
        df_fenetre = g[g["Periode"].isin(periodes_fenetre)].copy()
        
        # Filtrer : seulement les lignes avec prix ET indicatrice = 1
        df_actif = df_fenetre[
            (df_fenetre[col_prix].notna()) & 
            (df_fenetre[col_indicatrice] == 1)
        ].copy()
        
        if len(df_actif) == 0:
            result.append({
                "Periode": periode,
                "prix_mm": np.nan,
                "nb_observations": 0,
                "nb_typologies": 0
            })
            continue
        
        # Pondération : poids_relatif pour chaque observation
        total_poids = df_actif["poids_relatif"].sum()
        
        if total_poids > 0:
            poids_norm = df_actif["poids_relatif"] / total_poids
            prix_mm = np.average(df_actif[col_prix], weights=poids_norm)
        else:
            prix_mm = np.nan
        
        result.append({
            "Periode": periode,
            "prix_mm": prix_mm,
            "nb_observations": len(df_actif),
            "nb_typologies": df_actif.groupby(typokeys).ngroups
        })
    
    return pd.DataFrame(result)
