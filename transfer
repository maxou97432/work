import pandas as pd
import matplotlib.pyplot as plt

# 1️⃣ Calcul du pourcentage de NA par ville
na_par_ville = df_filtre.groupby("ville_")["Prix_m2"].apply(lambda x: x.isna().mean()*100)

# 2️⃣ Initialiser la série de catégories
categories = pd.Series(index=na_par_ville.index, dtype="object")

# 3️⃣ Attribuer les catégories spécifiques pour 0 et 100
categories[na_par_ville == 0] = "0%"
categories[na_par_ville == 100] = "100%"

# 4️⃣ Définir les intervalles pour les autres valeurs
bins = [0, 10, 30, 50, 85, 100]
labels = ["0-10%", "10-30%", "30-50%", "50-85%", "85-100%"]

# 5️⃣ Catégoriser les autres valeurs (excluant 0 et 100 déjà assignés)
mask = categories.isna()
categories[mask] = pd.cut(na_par_ville[mask], bins=bins, labels=labels, include_lowest=True, right=False)

# 6️⃣ Compter le nombre de villes par catégorie
counts = categories.value_counts().sort_index()

print("Nombre de villes par catégorie :")
print(counts)

# 7️⃣ Tracer le graphique
ax = counts.plot(kind="bar", figsize=(10,5), color="skyblue", edgecolor="k")
ax.set_xlabel("Tranches de % de NA")
ax.set_ylabel("Nombre de villes")
ax.set_title("Répartition des villes selon le pourcentage de valeurs manquantes")
plt.show()
