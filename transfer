import pandas as pd
import numpy as np

# --- Préparer df_final pour la comparaison ---
df_compare = pd.DataFrame(index=df_final.index)

for period, label in zip(['3 mois', '6 mois', '12 mois'], ['3m', '6m', '12m']):
    if (period, 'ALL') in df_final.columns:
        # Remplacer '-' par NaN, enlever les espaces et €, puis convertir en float en ignorant les NaN
        df_compare[f'MA Crédit {label}'] = (
            df_final[(period, 'ALL')]
            .replace('-', np.nan)                     # '-' -> NaN
            .str.replace(' €','', regex=False)        # enlever le €
            .str.replace(' ','', regex=False)         # enlever les espaces
            .apply(pd.to_numeric, errors='coerce')    # convertir en float, mettre NaN si impossible
        )

# --- Préparer df_moyennes pour la comparaison ---
df_moyennes_index_clean = df_moyennes.copy()
df_moyennes_index_clean.index = df_moyennes_index_clean.index.str.split(' - ').str[1]

df_moyennes_index_clean = df_moyennes_index_clean.rename(columns={
    'Moyenne 3 derniers mois': 'MA Meilleurs Agents 3m',
    'Moyenne 6 derniers mois': 'MA Meilleurs Agents 6m',
    'Moyenne 12 derniers mois': 'MA Meilleurs Agents 12m'
})

# --- Fusionner les deux tableaux sur le département ---
df_final_compare = df_compare.merge(df_moyennes_index_clean, left_index=True, right_index=True, how='outer')

# --- Affichage final avec formatage €
for col in df_final_compare.columns:
    df_final_compare[col] = df_final_compare[col].apply(lambda x: f"{x:,.0f} €" if pd.notna(x) else '-')

print(df_final_compare)
