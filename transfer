<class 'pandas.core.frame.DataFrame'>
RangeIndex: 11152019 entries, 0 to 11152018
Data columns (total 90 columns):
 #   Column                          Dtype         
---  ------                          -----         
 0   CD_OP                           object        
 1   CD_NATUR_OP                     object        
 2   MT_ENCOURS                      float32       
 3   CD_STATUT                       object        
 4   NB_SURF_HAB                     float64       
 5   NB_SURF_CREE                    float32       
 6   NB_PIECES                       float64       
 7   NB_SURF_TER                     float64       
 8   MT_VAL                          float32       
 9   VALEUR_FONCIERE                 float32       
 10  MT_REVENU_ANN                   float32       
 11  AGE_EMP1                        float32       
 12  AGE_EMP2                        float32       
 13  CD_CSP_EMP1                     object        
 14  CD_CSP_EMP2                     object        
 15  CD_ETAT_CIVIL                   float32       
 16  nb_enf_charge                   float32       
 17  DT_MEP                          datetime64[ns]
 18  DT_RECEP                        datetime64[ns]
 19  MT_OPE                          float32       
 20  TYPE_BIEN                       object        
 21  RNVP_SCORING                    object        
 22  RNVP_ADRESSE2                   object        
 23  RNVP_ADRESSE3                   object        
 24  RNVP_NUM_VOIE                   object        
 25  ADRESSE_SUFFIXE                 object        
 26  ADRESSE4                        object        
 27  RNVP_ADRESSE5                   object        
 28  RNVP_ADRESSE6                   object        
 29  RNVP_GEO_PG                     object        
 30  LONGITUDE                       float32       
 31  LATITUDE                        float32       
 32  CD_INDI_EMP1                    object        
 33  CD_INDI_EMP2                    object        
 34  MT_POSTCOUT_TVX                 float64       
 35  OP_MEP                          float64       
 36  DEPT                            object        
 37  RNVP_VILLE                      object        
 38  CODE_POSTAL_Init                object        
 39  LIBELLE_DEPT                    object        
 40  adresse_suff                    object        
 41  cle_voie                        object        
 42  KEY_LONG_LAT                    object        
 43  KEY_LONG_LAT3                   object        
 44  KEY_LONG_LAT1                   object        
 45  CLE_INTEROP_ADR                 object        
 46  verif_adresse                   object        
 47  ADRESSEM                        object        
 48  id_                             float64       
 49  idx_                            object        
 50  CODE_POSTAL                     object        
 51  ville_                          object        
 52  adr0                            object        
 53  adr_                            object        
 54  num_voie_                       object        
 55  type_voie_                      object        
 56  adr_bis                         object        
 57  dept_                           object        
 58  prenom_voie_                    object        
 59  NUM_VOIE_SUFF                   object        
 60  SOURCE                          object        
 61  DATE_MUTATION                   datetime64[ns]
 62  ID_MUTATION                     object        
 63  DEPT_Corse_2A_2B                object        
 64  Prix_m2                         float64       
 65  Prix_piece                      float64       
 66  nb_m2_by_piece                  float64       
 67  TVX_prix_m2                     float64       
 68  DATE                            datetime64[ns]
 69  YEAR                            int64         
 70  CD_INDI_MIN                     object        
 71  CD_INDI_MAX                     object        
 72  AGE_EMP_MIN                     float32       
 73  AGE_EMP_MAX                     float32       
 74  CD_CSP_EMP_MIN                  object        
 75  CD_CSP_EMP_MAX                  object        
 76  ID                              int64         
 77  ID_DEDOUB                       object        
 78  SCORE_COMPLETUDE                int32         
 79  ID_PARCELLE                     object        
 80  MAX_surface_reelle_bati_unique  float64       
 81  NOMBRE_LOTS                     float64       
 82  nb_PARCELLES                    float64       
 83  Habitation_unique               float64       
 84  Dependance_unique               float64       
 85  Terrain_unique                  float64       
 86  nb_TYPE_LOCAL_Maison            float64       
 87  nb_TYPE_LOCAL_Appartement       float64       
 88  nb_TYPE_LOCAL_Dépendance        float64       
 89  NATURE_MUTATION                 object        
dtypes: datetime64[ns](4), float32(14), float64(19), int32(1), int64(2), object(50)
memory usage: 6.9+ GB
import pandas as pd
# --- Imports (au besoin) ---
import pandas as pd
import numpy as np

# 1) Comptes bruts par YEAR x SOURCE
df_counts = (base_ml
             .groupby(['YEAR', 'SOURCE'], dropna=False)['ID']
             .count()
             .reset_index(name='Transactions'))

# 2) Tableau des comptes (valeurs absolues) – pratique pour l’audit
tab_counts = (df_counts
              .pivot(index='YEAR', columns='SOURCE', values='Transactions')
              .fillna(0)
              .astype(int))

# 3) Tableau des pourcentages par année (lignes normalisées)
tab_pct = tab_counts.div(tab_counts.sum(axis=1), axis=0).mul(100)

# 4) (Optionnel) Ajouter les totaux colonnes + ligne pour le tableau de comptes
tab_counts['_Total'] = tab_counts.sum(axis=1)
tab_counts.loc['_Total'] = tab_counts.sum(axis=0)

# 5) Affichage propre en notebook : style + heatmap Plotly
try:
    # Styling pandas (notebook / Jupyter)
    styled_pct = (
        tab_pct.round(2)
        .style.format("{:.2f}%")
        .set_caption("Couverture des transactions par source (en %)")
        .background_gradient(axis=None, cmap="Blues")
        .highlight_max(axis=1, color="#D1FAE5")  # met en avant la source dominante par année
    )
    display(styled_pct)
    
    # Carte thermique (heatmap) – super lisible en réunion
    import plotly.express as px
    fig_heat = px.imshow(
        tab_pct,
        aspect='auto',
        color_continuous_scale='Blues',
        labels=dict(color="%"),
        title="Répartition % des transactions par source (Heatmap)"
    )
    fig_heat.update_xaxes(title="SOURCE")
    fig_heat.update_yaxes(title="YEAR")
    fig_heat.show()

    # Stacked bar en % (lecture “quelle source pèse combien chaque année ?”)
    df_for_bar = df_counts.copy()
    import plotly.express as px
    fig_bar = px.bar(
        df_for_bar, x="YEAR", y="Transactions", color="SOURCE",
        barmode="stack", text_auto=True, title="Part des sources par année (en %)",
        # groupnorm='fraction' mettra en proportion; pour Plotly <5.17, utilisez 'percent'
        groupnorm='percent'
    )
    fig_bar.update_layout(yaxis_title="Pourcentage", xaxis_title="Année")
    fig_bar.show()

except Exception as e:
    # Fallback console si pas en environnement notebook/plotly
    print("Tableau de couverture des transactions par source (en %):")
    print(tab_pct.round(2).to_string())
    print("\nTableau des transactions (valeurs absolues) avec totaux:")
    print(tab_counts.to_string())
    print(f"\n(Note: affichage enrichi non disponible ici) Détails: {e}")

