import pandas as pd

resultats = []

# Calcul de la moyenne glissante
df_filtre["moyenne_glissante_12m"] = (
    df_filtre.groupby("ville_")["Prix_m2"]
    .rolling(window=12, min_periods=10)
    .mean()
    .reset_index(level=0, drop=True)
)

for ville, groupe in df_filtre.groupby("ville_"):
    # Trier par date pour travailler chronologiquement
    groupe = groupe.sort_values("DATE").reset_index(drop=True)

    # Dernière valeur valide de Prix_m2
    groupe_prix_valide = groupe[groupe["Prix_m2"].notna()]
    if groupe_prix_valide.empty:
        continue
    last_row = groupe_prix_valide.iloc[-1]
    date_last = last_row["DATE"]
    prix_last = last_row["Prix_m2"]

    # Dernière valeur valide de la moyenne glissante
    groupe_moy_valide = groupe[groupe["moyenne_glissante_12m"].notna()]
    if groupe_moy_valide.empty:
        continue
    moyenne_last = groupe_moy_valide.iloc[-1]["moyenne_glissante_12m"]

    # Date de référence pour l'année précédente
    date_previous = date_last - pd.DateOffset(years=1)
    groupe_previous = groupe[groupe["DATE"] <= date_previous]

    # Calcul de l'évolution annuelle
    evolution = None
    if not groupe_previous.empty:
        groupe_prev_moy_valide = groupe_previous[groupe_previous["moyenne_glissante_12m"].notna()]
        if not groupe_prev_moy_valide.empty:
            moyenne_previous = groupe_prev_moy_valide.iloc[-1]["moyenne_glissante_12m"]
            evolution = ((moyenne_last - moyenne_previous) / moyenne_previous) * 100

    resultats.append({
        "ville": ville,
        "derniere_date_valide": date_last.date(),
        "evolution_%": round(evolution, 2) if evolution is not None else None,
        "prix_m2_derniere_date_enregistree": prix_last
    })

# Création du DataFrame final
rdf = pd.DataFrame(resultats)
rdf


